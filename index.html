<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Medidor por Foto</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, system-ui, Arial;
      background: #0b0b0f;
      color: #fff;
    }

    header {
      padding: 12px;
      background: #0f0f16;
      border-bottom: 1px solid #222;
    }

    .box {
      background: #171722;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }

    input[type="file"] {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #2b5cff;
      color: #fff;
    }

    input[type="number"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      margin-top: 6px;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      margin-top: 8px;
      background: #2b5cff;
      color: #fff;
    }

    #result {
      font-size: 22px;
      font-weight: bold;
      margin-top: 6px;
    }

    canvas {
      width: 100%;
      height: calc(100vh - 320px);
      background: #000;
      touch-action: none;
      display: block;
    }
  </style>
</head>

<body>

<header>
  <div class="box">
    <div><b>1) Subir foto</b></div>
    <input id="file" type="file" accept="image/*">
  </div>

  <div class="box">
    <div><b>2) Medida real conocida (cm)</b></div>
    <input id="realValue" type="number" placeholder="Ej: 200">
    <button id="setScale">Guardar escala</button>
  </div>

  <div class="box">
    <div><b>Resultado</b></div>
    <div id="result">â€”</div>
    <button id="reset">Reset puntos</button>
  </div>
</header>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const fileInput = document.getElementById('file');
const realInput = document.getElementById('realValue');
const setScaleBtn = document.getElementById('setScale');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');

let img = new Image();
let imgLoaded = false;

let p1 = null;
let p2 = null;
let realPerPx = null;

function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  draw();
}
window.addEventListener('resize', resize);

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (!imgLoaded) return;

  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  if (p1) drawPoint(p1);
  if (p1 && p2) {
    drawPoint(p2);
    drawLine(p1, p2);
    showResult();
  }
}

function drawPoint(p) {
  ctx.fillStyle = "#ffcc00";
  ctx.beginPath();
  ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
  ctx.fill();
}

function drawLine(a, b) {
  ctx.strokeStyle = "#2b5cff";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(a.x, a.y);
  ctx.lineTo(b.x, b.y);
  ctx.stroke();
}

function dist(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function showResult() {
  if (!realPerPx) {
    resultEl.textContent = dist(p1, p2).toFixed(1) + " px";
  } else {
    resultEl.textContent = (dist(p1, p2) * realPerPx).toFixed(1) + " cm";
  }
}

// ðŸ‘‰ CARGA DE FOTO (iPhone SAFE)
fileInput.addEventListener('change', () => {
  const file = fileInput.files && fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    img = new Image();
    img.onload = () => {
      imgLoaded = true;
      p1 = null;
      p2 = null;
      realPerPx = null;
      resize();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

// ðŸ‘‰ TOQUES EN CANVAS
canvas.addEventListener('click', (e) => {
  if (!imgLoaded) return;

  const rect = canvas.getBoundingClientRect();
  const p = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };

  if (!p1) p1 = p;
  else if (!p2) p2 = p;
  else {
    p1 = p;
    p2 = null;
  }

  draw();
});

// ðŸ‘‰ GUARDAR ESCALA
setScaleBtn.addEventListener('click', () => {
  if (!p1 || !p2) {
    alert("MarcÃ¡ 2 puntos primero");
    return;
  }
  const real = Number(realInput.value);
  if (!real || real <= 0) {
    alert("IngresÃ¡ una medida real vÃ¡lida");
    return;
  }
  realPerPx = real / dist(p1, p2);
  draw();
});

// ðŸ‘‰ RESET
resetBtn.addEventListener('click', () => {
  p1 = null;
  p2 = null;
  resultEl.textContent = "â€”";
  draw();
});

resize();
</script>

</body>
</html>

