<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Medidor por Foto</title>

  <style>
    body { margin:0; font-family:-apple-system,system-ui,Arial; background:#0b0b0f; color:#fff; }
    header { padding:12px; background:#0f0f16; border-bottom:1px solid #222; }
    .box { background:#171722; border-radius:10px; padding:10px; margin-bottom:10px; }
    input[type="file"]{
      width:100%; padding:14px; font-size:18px; border-radius:10px; border:none;
      background:#2b5cff; color:#fff;
    }
    input[type="number"]{
      width:100%; padding:12px; font-size:18px; border-radius:10px; border:none; margin-top:6px;
    }
    button{
      width:100%; padding:14px; font-size:18px; border-radius:10px; border:none;
      margin-top:8px; background:#2b5cff; color:#fff;
    }
    #result{ font-size:20px; font-weight:700; margin-top:6px; }
    #hint{ opacity:.85; font-size:13px; margin-top:4px; }
    #stageWrap{ padding:12px; }
    /* ALTURA SEGURA para iPhone: evita 100vh bugs */
    #canvas{
      width:100%;
      height: 45vh;
      min-height: 280px;
      max-height: 520px;
      background:#000;
      border-radius:12px;
      display:block;
      touch-action:none;
    }
    #err{
      padding:10px 12px; margin:12px; border-radius:10px;
      background:#ff3b30; color:#fff; display:none; white-space:pre-wrap;
    }
  </style>
</head>

<body>

<div id="err"></div>

<header>
  <div class="box">
    <div><b>1) Subir foto</b></div>
    <input id="file" type="file" accept="image/*">
    <div id="hint">Si no aparece la imagen: probá Safari y recargá.</div>
  </div>

  <div class="box">
    <div><b>2) Calibrar con una medida real (cm)</b></div>
    <div style="opacity:.9;font-size:13px;margin-top:4px;">Marcá 2 puntos sobre una distancia conocida (ej: ancho real).</div>
    <input id="realValue" type="number" placeholder="Ej: 200">
    <button id="setScale">Guardar escala</button>
  </div>

  <div class="box">
    <div><b>Resultado</b></div>
    <div id="result">Subí una foto. Luego tocá 2 puntos.</div>
    <button id="reset">Reset puntos</button>
  </div>
</header>

<div id="stageWrap">
  <canvas id="canvas"></canvas>
</div>

<script>
(() => {
  const errBox = document.getElementById('err');
  function showErr(e){
    errBox.style.display = 'block';
    errBox.textContent = 'Error: ' + (e && e.message ? e.message : String(e));
  }

  try {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const fileInput = document.getElementById('file');
    const realInput = document.getElementById('realValue');
    const setScaleBtn = document.getElementById('setScale');
    const resetBtn = document.getElementById('reset');
    const resultEl = document.getElementById('result');

    let img = new Image();
    let imgLoaded = false;

    // Transform para mantener proporción
    let drawScale = 1;
    let offX = 0;
    let offY = 0;

    // puntos en coordenadas del CANVAS
    let p1 = null, p2 = null;

    // cm por pixel EN CANVAS
    let cmPerPx = null;

    function resizeCanvas() {
      // iguala el tamaño real del canvas a su tamaño visible
      const r = canvas.getBoundingClientRect();
      canvas.width = Math.max(1, Math.round(r.width));
      canvas.height = Math.max(1, Math.round(r.height));
      if (imgLoaded) fitImage();
      draw();
    }

    function fitImage() {
      const scaleX = canvas.width / img.width;
      const scaleY = canvas.height / img.height;
      drawScale = Math.min(scaleX, scaleY);

      const w = img.width * drawScale;
      const h = img.height * drawScale;

      offX = (canvas.width - w) / 2;
      offY = (canvas.height - h) / 2;
    }

    function insideImage(p){
      if(!imgLoaded) return false;
      const w = img.width * drawScale;
      const h = img.height * drawScale;
      return (p.x >= offX && p.x <= offX + w && p.y >= offY && p.y <= offY + h);
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!imgLoaded) return;

      ctx.drawImage(img, offX, offY, img.width*drawScale, img.height*drawScale);

      if(p1) drawPoint(p1);
      if(p1 && p2){
        drawPoint(p2);
        drawLine(p1,p2);
        showResult();
      }
    }

    function drawPoint(p){
      ctx.fillStyle = "#ffcc00";
      ctx.beginPath();
      ctx.arc(p.x,p.y,7,0,Math.PI*2);
      ctx.fill();
    }

    function drawLine(a,b){
      ctx.strokeStyle="#2b5cff";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
      ctx.stroke();
    }

    function dist(a,b){
      return Math.hypot(a.x-b.x, a.y-b.y);
    }

    function showResult(){
      if(!cmPerPx){
        resultEl.textContent = "Ahora tocá “Guardar escala” para convertir a cm.";
        return;
      }
      const cm = dist(p1,p2) * cmPerPx;
      resultEl.textContent = cm.toFixed(1) + " cm";
    }

    // Cargar imagen con FileReader (iPhone safe)
    fileInput.addEventListener('change', () => {
      const f = fileInput.files && fileInput.files[0];
      if(!f) return;

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const newImg = new Image();
        newImg.onload = () => {
          img = newImg;
          imgLoaded = true;
          p1 = null; p2 = null; cmPerPx = null;
          resultEl.textContent = "Imagen cargada. Tocá 2 puntos para calibrar.";
          resizeCanvas();
        };
        newImg.onerror = () => showErr("No se pudo cargar la imagen.");
        newImg.src = dataUrl;
      };
      reader.onerror = () => showErr("FileReader falló.");
      reader.readAsDataURL(f);
    });

    // clicks
    canvas.addEventListener('click', (e) => {
      if(!imgLoaded) return;

      const r = canvas.getBoundingClientRect();
      const p = { x: e.clientX - r.left, y: e.clientY - r.top };

      // evita que marques fuera de la imagen
      if(!insideImage(p)) return;

      if(!p1) p1 = p;
      else if(!p2) p2 = p;
      else { p1 = p; p2 = null; }

      draw();
    });

    // Calibrar (regla de 3)
    setScaleBtn.addEventListener('click', () => {
      if(!p1 || !p2){
        alert("Marcá 2 puntos sobre una medida conocida primero.");
        return;
      }
      const realCm = Number(realInput.value);
      if(!realCm || realCm <= 0){
        alert("Ingresá una medida real en cm (ej: 200).");
        return;
      }
      cmPerPx = realCm / dist(p1,p2);
      resultEl.textContent = "Escala guardada. Ahora medí otra distancia tocando 2 puntos.";
      draw();
    });

    resetBtn.addEventListener('click', () => {
      p1=null; p2=null;
      resultEl.textContent = "Puntos reseteados. Tocá 2 puntos.";
      draw();
    });

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

  } catch(e){
    showErr(e);
  }
})();
</script>

</body>
</html>
