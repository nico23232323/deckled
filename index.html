<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const fileInput = document.getElementById('file');
const realInput = document.getElementById('realValue');
const setScaleBtn = document.getElementById('setScale');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');

let img = new Image();
let imgLoaded = false;

// Imagen sin deformar
let imgScale = 1;
let imgOffsetX = 0;
let imgOffsetY = 0;

// Puntos en coordenadas CANVAS
let p1 = null;
let p2 = null;

// Escala real (cm por pixel)
let cmPerPx = null;

function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  if (imgLoaded) fitImage();
  draw();
}
window.addEventListener('resize', resize);

function fitImage() {
  const scaleX = canvas.width / img.width;
  const scaleY = canvas.height / img.height;
  imgScale = Math.min(scaleX, scaleY);

  const imgW = img.width * imgScale;
  const imgH = img.height * imgScale;

  imgOffsetX = (canvas.width - imgW) / 2;
  imgOffsetY = (canvas.height - imgH) / 2;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!imgLoaded) return;

  // Imagen sin deformar
  ctx.drawImage(
    img,
    imgOffsetX,
    imgOffsetY,
    img.width * imgScale,
    img.height * imgScale
  );

  if (p1) drawPoint(p1);
  if (p1 && p2) {
    drawPoint(p2);
    drawLine(p1, p2);
    showResult();
  }
}

function drawPoint(p) {
  ctx.fillStyle = "#ffcc00";
  ctx.beginPath();
  ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
  ctx.fill();
}

function drawLine(a, b) {
  ctx.strokeStyle = "#2b5cff";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(a.x, a.y);
  ctx.lineTo(b.x, b.y);
  ctx.stroke();
}

function dist(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function showResult() {
  if (!cmPerPx) {
    resultEl.textContent = "DefinÃ­ una medida real primero";
    return;
  }
  const cm = dist(p1, p2) * cmPerPx;
  resultEl.textContent = cm.toFixed(1) + " cm";
}

// ðŸ“¸ Cargar imagen (iPhone safe)
fileInput.addEventListener('change', () => {
  const file = fileInput.files && fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    img = new Image();
    img.onload = () => {
      imgLoaded = true;
      p1 = null;
      p2 = null;
      cmPerPx = null;
      fitImage();
      draw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

// ðŸ‘‰ Tap en canvas
canvas.addEventListener('click', (e) => {
  if (!imgLoaded) return;

  const rect = canvas.getBoundingClientRect();
  const p = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };

  if (!p1) p1 = p;
  else if (!p2) p2 = p;
  else {
    p1 = p;
    p2 = null;
  }

  draw();
});

// ðŸ“ Guardar escala real (regla de 3)
setScaleBtn.addEventListener('click', () => {
  if (!p1 || !p2) {
    alert("MarcÃ¡ primero la medida conocida");
    return;
  }
  const realCm = Number(realInput.value);
  if (!realCm || realCm <= 0) {
    alert("IngresÃ¡ una medida real en cm");
    return;
  }

  cmPerPx = realCm / dist(p1, p2);
  draw();
});

// ðŸ”„ Reset
resetBtn.addEventListener('click', () => {
  p1 = null;
  p2 = null;
  resultEl.textContent = "â€”";
  draw();
});

resize();
</script>
