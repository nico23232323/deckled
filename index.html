<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Medidor por Foto</title>

  <style>
    body{
      margin:0;
      font-family:-apple-system,system-ui,Arial;
      background:#0b0b0f;
      color:#fff;
    }

    header{
      padding:8px;
      background:#0f0f16;
      border-bottom:1px solid #222;
    }

    .box{
      background:#171722;
      border-radius:10px;
      padding:8px;
      margin-bottom:8px;
    }

    input[type="file"]{
      width:100%;
      padding:10px;
      font-size:14px;
      border-radius:8px;
      border:none;
      background:#2b5cff;
      color:#fff;
    }

    input[type="number"]{
      width:100%;
      padding:8px;
      font-size:14px;
      border-radius:8px;
      border:none;
      margin-top:4px;
    }

    button{
      width:100%;
      padding:10px;
      font-size:14px;
      border-radius:8px;
      border:none;
      margin-top:6px;
      background:#2b5cff;
      color:#fff;
    }

    .row{
      display:flex;
      gap:6px;
    }

    .row button{
      padding:8px;
      font-size:13px;
    }

    #result{
      font-size:16px;
      font-weight:600;
      margin-top:4px;
    }

    #hint{
      opacity:.8;
      font-size:11px;
      margin-top:4px;
      line-height:1.2;
    }

    #stageWrap{
      padding:8px;
    }

    /* MÁS espacio de trabajo */
    #canvas{
      width:100%;
      height:55vh;
      min-height:340px;
      max-height:70vh;
      background:#000;
      border-radius:12px;
      display:block;
      touch-action:none;
    }

    #err{
      padding:8px 10px;
      margin:8px;
      border-radius:8px;
      background:#ff3b30;
      color:#fff;
      display:none;
      white-space:pre-wrap;
      font-size:13px;
    }
  </style>
</head>

<body>

<div id="err"></div>

<header>
  <div class="box">
    <b>1) Subir foto</b>
    <input id="file" type="file" accept="image/*">
    <div id="hint">
      1 dedo: marcar puntos · 2 dedos: zoom + mover
    </div>
  </div>

  <div class="box">
    <b>Zoom</b>
    <div class="row">
      <button id="zoomOut">−</button>
      <button id="zoomReset">Reset</button>
      <button id="zoomIn">+</button>
    </div>
  </div>

  <div class="box">
    <b>2) Calibrar (cm)</b>
    <input id="realValue" type="number" placeholder="Ej: 200">
    <button id="setScale">Guardar escala</button>
  </div>

  <div class="box">
    <b>Resultado</b>
    <div id="result">Subí una foto y marcá 2 puntos.</div>
    <button id="resetPoints">Reset puntos</button>
  </div>
</header>

<div id="stageWrap">
  <canvas id="canvas"></canvas>
</div>

<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const fileInput = document.getElementById('file');
  const realInput = document.getElementById('realValue');
  const setScaleBtn = document.getElementById('setScale');
  const resetPointsBtn = document.getElementById('resetPoints');
  const resultEl = document.getElementById('result');

  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const zoomResetBtn = document.getElementById('zoomReset');

  let img = new Image();
  let imgLoaded = false;

  let baseScale = 1, offX = 0, offY = 0;
  let zoom = 1, panX = 0, panY = 0;

  let p1 = null, p2 = null;
  let cmPerPx = null;

  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = r.width;
    canvas.height = r.height;
    if(imgLoaded) fitImage();
    draw();
  }

  function fitImage(){
    baseScale = Math.min(canvas.width / img.width, canvas.height / img.height);
    offX = (canvas.width - img.width * baseScale) / 2;
    offY = (canvas.height - img.height * baseScale) / 2;
    zoom = 1; panX = 0; panY = 0;
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!imgLoaded) return;

    const scale = baseScale * zoom;
    ctx.drawImage(
      img,
      offX + panX,
      offY + panY,
      img.width * scale,
      img.height * scale
    );

    if(p1) drawPoint(p1);
    if(p1 && p2){
      drawPoint(p2);
      drawLine(p1,p2);
      showResult();
    }
  }

  function drawPoint(p){
    ctx.fillStyle="#ffcc00";
    ctx.beginPath();
    ctx.arc(p.x,p.y,6,0,Math.PI*2);
    ctx.fill();
  }

  function drawLine(a,b){
    ctx.strokeStyle="#2b5cff";
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(b.x,b.y);
    ctx.stroke();
  }

  function dist(a,b){
    return Math.hypot(a.x-b.x, a.y-b.y);
  }

  function showResult(){
    if(!cmPerPx){
      resultEl.textContent="Guardá la escala para medir en cm";
      return;
    }
    resultEl.textContent=(dist(p1,p2)*cmPerPx).toFixed(1)+" cm";
  }

  fileInput.addEventListener('change', ()=>{
    const f = fileInput.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      img = new Image();
      img.onload = ()=>{
        imgLoaded = true;
        p1=null; p2=null; cmPerPx=null;
        resize();
        resultEl.textContent="Imagen cargada. Marcá 2 puntos.";
      };
      img.src = r.result;
    };
    r.readAsDataURL(f);
  });

  canvas.addEventListener('click', e=>{
    if(!imgLoaded) return;
    const r = canvas.getBoundingClientRect();
    const p = { x:e.clientX-r.left, y:e.clientY-r.top };
    if(!p1) p1=p;
    else if(!p2) p2=p;
    else{ p1=p; p2=null; }
    draw();
  });

  setScaleBtn.addEventListener('click', ()=>{
    if(!p1||!p2) return alert("Marcá 2 puntos primero");
    const cm = Number(realInput.value);
    if(!cm) return alert("Ingresá una medida real");
    cmPerPx = cm / dist(p1,p2);
    draw();
  });

  resetPointsBtn.addEventListener('click', ()=>{
    p1=null; p2=null;
    resultEl.textContent="Puntos reseteados";
    draw();
  });

  zoomInBtn.onclick=()=>{ zoom=Math.min(zoom*1.25,6); draw(); };
  zoomOutBtn.onclick=()=>{ zoom=Math.max(zoom/1.25,1); draw(); };
  zoomResetBtn.onclick=()=>{ zoom=1; panX=0; panY=0; draw(); };

  window.addEventListener('resize', resize);
  resize();
})();
</script>

</body>
</html>

